# AUTO-GENERATED from ci.hone â€” do not edit directly.
# Source: .github/workflows/ci.hone
#
name: CI
"on": [push, pull_request]
env:
  CARGO_TERM_COLOR: always
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo check --all-targets
      - name: Test
        run: cargo test
      - name: Clippy
        run: cargo clippy -- -D warnings
      - name: Format check
        run: cargo fmt -- --check
      - name: Build release
        run: cargo build --release
      - name: Verify examples
        run: |-
          for f in examples/*.hone; do
            echo "  Compiling $f..."
            ./target/release/hone compile "$f" --format yaml > /dev/null
          done
          tmpdir=$(mktemp -d)
          echo "  Compiling examples/microservices/main.hone..."
          ./target/release/hone compile examples/microservices/main.hone --format yaml --output-dir "$tmpdir"
          rm -rf "$tmpdir"
          echo "  Compiling examples/ci-pipeline/main.hone..."
          ./target/release/hone compile examples/ci-pipeline/main.hone --format yaml > /dev/null
          echo "  Compiling examples/ansible-playbook/main.hone..."
          ./target/release/hone compile examples/ansible-playbook/main.hone --format yaml > /dev/null
          ./target/release/hone compile examples/ansible-playbook/main.hone --format yaml --variant env=production > /dev/null
      - name: Verify stdin
        run: "echo 'name: \"test\"' | ./target/release/hone compile - --format yaml"
      - name: Verify version
        run: ./target/release/hone --version
      - name: "Dogfood: verify CI workflow matches Hone source"
        run: |-
          ./target/release/hone compile .github/workflows/ci.hone --format yaml > /tmp/ci-check.yml
          # Strip the auto-generated header (first 3 lines) before comparing
          tail -n +4 .github/workflows/ci.yml > /tmp/ci-current.yml
          # Ensure both files end with a newline
          [ -n "$(tail -c1 /tmp/ci-current.yml)" ] && echo >> /tmp/ci-current.yml
          [ -n "$(tail -c1 /tmp/ci-check.yml)" ] && echo >> /tmp/ci-check.yml
          diff -u /tmp/ci-current.yml /tmp/ci-check.yml || (echo "ci.yml is out of date! Recompile from ci.hone" && exit 1)
  wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: hone-wasm
      - name: Build WASM
        run: cd hone-wasm && cargo build --release --target wasm32-unknown-unknown